var game;var params={};var __same_chars=["ё","е","«",'"',"»",'"',"—","-","–","-"];var tplAnonymPlayer=new Template('<div class="player #{you}" id=player#{id}><div class=rating id=rating#{id} style="display: none;"></div>#{rating_loading_html}<table class="car" id=car#{id}><tr><td class="name">#{name}</td><td><div class=imgcont id=imgcont#{id}><div class="img car1" style="background-color: #777777"></div></div></td></tr></table><div class=divider><img src="/img/blank.gif"></div></div>');var tplUserPlayer=new Template('<div class="player #{you}" id=player#{id}><div class=rating id=rating#{id} style="display: none;"></div>#{rating_loading_html}<table class="car" id=car#{id}><tr><td class="name"><div class="name_content"><table><tr><th>#{avatar_html}</th><td><div class="nick_content"><a href="/profile/#{user.id}/" class="#{user.colored_rang} profile" onmousemove="showProfilePopup(#{user.id});" onmouseover="showProfilePopup(#{user.id});" onmouseout="hideProfilePopup(#{user.id});">#{name}</a></div></td></tr></table></div></td><td><div style="position: relative;"><div class=imgcont id=imgcont#{id} style="background: #{user.background}"><div class="img car#{user.car} car-base_#{user.tuning[0]}" style="background-color: transparent; color: #{color}"><div class="img car#{user.car} car-tuning car-tuning1_#{user.tuning[1]}"><div class="img car#{user.car} car-tuning car-tuning2_#{user.tuning[2]}"><div class="img car#{user.car} car-tuning car-tuning3_#{user.tuning[3]}"></div></div></div></div>#{rating_html}#{award_html}</div></div></td></tr></table><div class=divider><img src="/img/blank.gif"></div></div>');var tplRatingWAwardPlayer=new Template('<div title="Позиция в недельной таблице" class=car_rating style="color: #{color}; padding-right: 14px;"><span class=bitless2>№</span>#{user.rating7}</div>');var tplRatingPlayer=new Template('<div title="Позиция в недельной таблице" class=car_rating style="color: #{color};"><span class=bitless2>№</span>#{user.rating7}</div>');var strAwardPlayer={1:'<i class="award award1" border=0 title="Медаль за 300 текстов пробега"></i>',2:'<i class="award award2" border=0 title="Звезда за 1000 текстов пробега"></i>',3:'<i class="award award3" border=0 title="Кубок за 2000 текстов пробега"></i>',4:'<i class="award award4" border=0 title="Корона за 5000 текстов пробега"></i>',5:'<i class="award award5" border=0 title="Золотой шлем за 10000 текстов пробега"></i>',6:'<i class="award award6" border=0 title="Бриллиантовый шлем за 20000 текстов пробега"></i>'};var tplRating=new Template('<div><ins id=place#{id} class="place place#{place}">#{place} место</ins><ins id=rating_gained#{id}></ins></div> #{delresult}<div id=newrecord#{id} class=newrecord style="display:none">Рекорд!</div><div class=stats id=stats#{id}><div><span class=bitmore><span class=bitmore>#{time}</span></span>#{time_decimal}</div><div><span class=bitmore><span class=bitmore>#{speed}</span></span> <span id=znmin#{id}>зн/мин</span></div><div>#{errors_html}</div></div>');var tplRatingGained=new Template("<ins id=rating_gained#{id} class=rating_gained>+#{rating_gained}</ins>");var tplTypetextLine=new Template("<span class=#{hidden}><span id=typefocus class=#{highlight}>#{focus}</span><span id=afterfocus>#{after}</span></span>");var tplTypetextFull=new Template("<span class=#{hidden}><span id=beforefocus>#{before}</span><span id=typefocus class=#{highlight}>#{focus}</span><span id=afterfocus>#{after}</span></span>");var tplMarathonThis=new Template('<a class=marathon_this href="/play/#{id}.marathon-this">Марафон</a>');var tplBook={book:new Template("	Вы набирали цитату из книги:	<div class=name>#{textinfo.author} &laquo;#{textinfo.name}&raquo;</div>"),ozon:new Template('		<table id=book>		<tr>		<th>		<a target=_top href="http://www.ozon.ru/context/detail/id/#{textinfo.tag}/?partner=klavogonki" target=_blank><div class=book-border><img src="/ozon_img/#{textinfo.tag}.jpg"></div></a>		</th>		<td>			<div>Вы набирали цитату из книги:</div>			<div class=author>#{textinfo.author}</div>			<div class=name><a target=_blank href="http://www.ozon.ru/context/detail/id/#{textinfo.tag}/?partner=klavogonki">#{textinfo.name}</a></div>		</td>		</tr></table>'),ozon_nolink:new Template('			<table id=book>			<tr>			<th>			<div class=book-border><img src="/ozon_img/#{textinfo.tag}.jpg"></div>			</th>			<td>				<div>Вы набирали цитату из книги:</div>				<div class=author>#{textinfo.author}</div>				<div class=name>#{textinfo.name}</div>			</td>			</tr></table>'),imobilco:new Template('		<table id=book class="imobilco">		<tr>		<th>			<div class="imobilco-container">			<a target=_blank href="http://www.imobilco.ru/books/-/#{textinfo.tag}/?from-partner=klavogonki">			<div class="imobilco-book">			<span class="imobilco-cover"><span class="co itl"></span><span class="co itr"></span><span class="co ibl"></span><span class="co ibr"></span></span>			<img src="/imobilco_img/#{textinfo.tag}.jpg">			</div>			</a>			</div>		</th>		<td>			<div>Вы набирали цитату из книги:</div>			<div class=author>#{textinfo.author}</div>			<div class=name><a target=_blank href="http://www.imobilco.ru/books/-/#{textinfo.tag}/?from-partner=klavogonki">#{textinfo.name}</a></div>			<div class=imobilco-link><a target=_blank href="http://www.imobilco.ru/books/-/#{textinfo.tag}/?from-partner=klavogonki">Скачать книгу</a>#{marathon_this_html}</div>		</td>		</tr></table>'),imobilco_nolink:new Template('			<table id=book class="imobilco">			<tr>			<th>				<div class="imobilco-container">				<div class="imobilco-book">				<span class="imobilco-cover"><span class="co itl"></span><span class="co itr"></span><span class="co ibl"></span><span class="co ibr"></span></span>				<img src="/imobilco_img/#{textinfo.tag}.jpg">				</div>				</div>			</th>			<td>				<div>Вы набирали цитату из книги:</div>				<div class=author>#{textinfo.author}</div>				<div class=name>#{textinfo.name}</div>			</td>			</tr></table>'),news:new Template('	Вы набирали цитату из новости с сайта:	<div class=name>	<a target=_blank href="/play/#{id}.goto">	<i style="background: transparent url(/sources/#{textinfo.source.id}.gif) no-repeat 0% 0%;"></i>	#{textinfo.source.name}	</a>	</div>'),voc_unvoted:new Template('			Вы набирали текст по словарю &laquo;<a href="/vocs/#{params.voc.id}/">#{params.voc.name}</a>&raquo;			<div id=vote><a href="javascript:game.aeo4(-1);"><img border=0 title="Оценить словарь" title="Плохо" src="/img/thumb_down.gif"></a>&nbsp;<a href="javascript:game.aeo4(1);"><img border=0 title="Оценить словарь" alt="Хорошо" src="/img/thumb_up.gif"></a></div>'),voc_voted:new Template('			Вы набирали текст по словарю &laquo;<a href="/vocs/#{params.voc.id}/">#{params.voc.name}</a>&raquo;'),voc_book_unvoted:new Template('			Вы набирали #{textinfo.part}-й отрывок из словаря-книги &laquo;<a href="/vocs/#{params.voc.id}/">#{params.voc.name}</a>&raquo;			<div id=vote><a href="javascript:game.aeo4(-1);"><img border=0 title="Оценить словарь" title="Плохо" src="/img/thumb_down.gif"></a>&nbsp;<a href="javascript:game.aeo4(1);"><img border=0 title="Оценить словарь" alt="Хорошо" src="/img/thumb_up.gif"></a></div>'),voc_book_voted:new Template('			Вы набирали #{textinfo.part}-й отрывок из словаря-книги &laquo;<a href="/vocs/#{params.voc.id}/">#{params.voc.name}</a>&raquo;')};var tplBookinfoNormal=new Template("#{book_html}<div class=bar></div><table id=again><tr><td align=right><span class=hotkey>&larr; Ctrl</span><a href=\"javascript:void(0);\" onclick=\"if(chat) chat.leaveRoom('game#{id}'); window.location='/play/#{id}.gogamelist';\">К списку игр</a></td><td align=left><a href=\"javascript:void(0);\" onclick=\"if(chat) chat.leaveRoom('game#{id}'); window.location='/play/#{id}.replay';\">Играть еще раз</a><span class=hotkey>Ctrl &rarr;</span><br><span class=note>в этом же режиме</span></td></tr></table>");var tplBookinfoPractice=new Template('#{book_html}<div class=bar></div><div id=again><a title="Горячая клавиша: Ctrl &rarr;" href="javascript:void(0);" onclick="if(chat) chat.leaveRoom(\'game#{id}\'); window.location=\'/play/#{id}.replay\';">Играть еще раз</a><span class="hotkey alone">Ctrl &rarr;</span></div>');var tplBookinfoPrivate=new Template("#{book_html}");var tplBookinfoPrivateHost=new Template('#{book_html}<div class=bar></div><div id=again><a title="Горячая клавиша: Ctrl &rarr;" href="javascript:void(0);" onclick="if(chat) chat.leaveRoom(\'game#{id}\'); window.location=\'/play/#{id}.replay\';">Играть еще раз</a><span class="hotkey alone">Ctrl &rarr;</span><br><span class="bitless">(Другие игроки будут приглашены автоматически)</span></div>');var tplReplay=new Template('Игрок #{hostname} приглашает вас сыграть еще раз. <a href="/play/?gmid=#{id}">Присоединиться</a>');var tplChatAnonymPlayer=new Template('<span style="color: #{color}">#{name}</span>');var tplChatUserPlayer=new Template('<span style="display: inline; #{avatar_html} color: #{color}">#{name}</span>');var tplChatMessage={me:new Template("<li id=message_num_#{num}> <span class=message_time>#{time}</span> <span class=message_player>#{player_html}</span> <span class=message_text>#{text}</span></li>"),normal:new Template("<li id=message_num_#{num}> <span class=message_time>#{time}</span> <span class=message_player>#{player_html}</span>: <span class=message_text>#{text}</span></li>"),system:new Template('<li id=message_num_#{num} style="color: #999;"> <span class=message_time>#{time}</span> <span class=message_player>Игрок #{player_html}</span> <span class=message_text>#{text}</span></li>')};var tplChatUserAvatar=new Template("background: url(#{avatar}) no-repeat left; padding-left: 20px;");var tplDropMessageNewLevel=new Template('<h4 style="color: #b38f00">Новый уровень!</h4>										  <p>Поздравляем! Вы достигли <strong>#{level}-го уровня</strong>!<br/>										  	Вам начислено #{bonuses} бонусов.</p>');var strLoading='<img src="/img/loading.gif"><br><span class=orange>Загрузка</span>';var strCheat='<div align=center><div class=msg><div><p>Игра заблокирована из-за попытки мошенничества.</p><p>Если вы действительно нашли способ обмануть игру, отлично! Может теперь, когда вы достигли своей цели, стоит попрактиковаться в настоящем наборе?</p><p>Если вы видите это сообщение по ошибке, обратитесь по адресу <a href="mailto:mail@typeracer.ru">mail@typeracer.ru</a></p></div></div>';var strCaptchaOK='<div align=center><p>Спасибо, тест успешно пройден. Ваш результат зачислен.</p><input type=button class=btn value="Закрыть" onclick="$(\'captcha\').hide();"></div>';var strCaptchaFail='<div align=center><p>Тест пройден неверно. Попробуйте в следующий раз.</p><input type=button class=btn value="Закрыть" onclick="$(\'captcha\').hide();"></div>';var strRatingLoading='<div id=rating_loading style="display: none;">Результат засчитан. Подождите...</div>';var strRatingFail="Игрок сошел с трассы";var profilesCache=Array();var chatFocused=false;var cachedUsers=new Object();var inputtext_focused=false;var ufopos=0;var ufostr="";var speedpanel_top_loaded=false,speedpanel_arrow_loaded=false,speedpanel_back_loaded=false;Class.Methods.toArray=function(){return"asd"};var Player=Class.create({initialize:function(c){this.pos=0;var b;if(url_suffix&&Prototype.Browser.IE){var a=game.cookies.match(/player!!!(\d+),[a-z0-9]+@@@/);if(a&&a[1]==c.id){this.you=true}}if(b=getCookie("player")){var a=b.split(",");if(a[0]==c.id){this.you=true}}this.move_effect={state:"finished"};this.update(c)},kof5:function(c){tlog("Player::setPos "+this.info.id,{pos:c});this.pos=c;$("car"+this.info.id).style.top=0;var b=url_suffix?380:480;var a=Math.floor(c*b/(game.errorWork?game.original_words.length:game.words.length));if(game.custom&&game.params.mode=="marathon"){a=Math.floor(c*b/game.marathon_length);if(game.finished){a=b}}if(game.custom&&game.params.gametype=="noerror"&&this.info.errors>1){this.bbm3()}else{if(c){if(params.carmove=="smooth"&&(!game.params||!game.params.regular_competition)){if(this.move_effect.state!="finished"){this.move_effect.cancel()}this.move_effect=new Effect.Move($("car"+this.info.id),{x:a,y:0,mode:"absolute"})}else{$("car"+this.info.id).setStyle({left:a+"px",top:0})}}}},bbm3:function(){var a=$("rating"+this.info.id);a.update(strRatingFail);a.show();$("car"+this.info.id).setStyle({left:"480px"})},cjn3:function(){if(!__testmode){return null}var a={};for(var b in this){if(typeof this[b]!="function"&&typeof this[b]!="object"){a[b]=this[b]}}a.info=this.info;return a},update:function(c){tlog("Player::update "+(this.info?this.info.id:"?"),{that:this.cjn3(),info:c});if(this.info&&c.v<=this.info.v){return}this.tpl=tplAnonymPlayer;if(c.user!==null){if(typeof c.user=="object"){cachedUsers[c.user.id]=c.user}if(typeof c.user=="number"){c.user=cachedUsers[c.user]}}if(c.user){this.tpl=tplUserPlayer}var a=clone(this.info);this.info=clone(c);this.info.you="other";if(this.you){this.info.you="you"}if(this.info.user){this.info.color="#000000";if(/#[a-fA-F0-9]+/.test(this.info.user.color)){this.info.color=colortools.capByBrightness(this.info.user.color)}if(c.leave&&Prototype.Browser.Opera){this.info.user.background="white"}}if(this.info.avatar){this.info.avatar_html='<img src="'+this.info.avatar+'">'}if(this.info.user){this.info.award_html="";if(!game.params||!game.params.voc||game.params.voc.type!="book"){if(this.info.user.num_races>=20000){this.info.award_html=strAwardPlayer[6]}else{if(this.info.user.num_races>=10000){this.info.award_html=strAwardPlayer[5]}else{if(this.info.user.num_races>=5000){this.info.award_html=strAwardPlayer[4]}else{if(this.info.user.num_races>=2000){this.info.award_html=strAwardPlayer[3]}else{if(this.info.user.num_races>=1000){this.info.award_html=strAwardPlayer[2]}else{if(this.info.user.num_races>=300){this.info.award_html=strAwardPlayer[1]}}}}}}}if(this.info.user.rating7){if(this.info.award_html!=""){this.info.rating_html=tplRatingWAwardPlayer.evaluate(this.info)}else{this.info.rating_html=tplRatingPlayer.evaluate(this.info)}}if(!__user_prefs.no_colored_rangs){this.info.user.colored_rang="rang"+this.info.level}}if(this.you){this.info.rating_loading_html=strRatingLoading}if(this.you&&game.params&&game.params.competition&&this.info.user.scores!=parseInt($("userpanel-scores").innerHTML)){new Effect.NumberChange("userpanel-scores",this.info.user.scores)}if(this.info.ufo&&this.info.level!=9){this.info.level=9}if(game.gamestatus!="racing"||!$("player"+c.id)){if($("player"+c.id)){var b=this.tpl.evaluate(this.info);if(this.cache_content!=b){$("player"+c.id).replace(b)}this.cache_content=b}else{if(this.you){$("players").insert({top:this.tpl.evaluate(this.info)})}else{$("players").insert(this.tpl.evaluate(this.info))}if(params.carmove=="smooth"){new Effect.PlayerEnterRace("car"+this.info.id)}}}else{this.kof5(c.pos);if((this.you&&c._finished||c.finished)&&game.places.indexOf(c.id)==-1){tlog("place push ok - "+c.id);game.places.push(c.id);game.places.sort(function(e,d){if(game.custom&&game.params.mode=="marathon"){var g=game.players[d].info.charsTotal;var f=game.players[e].info.charsTotal}else{var g=game.players[e].info._finished;var f=game.players[d].info._finished}if(g==f){return game.players[e].info.errors-game.players[d].info.errors}else{return g-f}})}}if(a){if(!a.leave&&c.leave){new Effect.Opacity("imgcont"+c.id,{from:1,to:0.3,duration:0.5});if(c.leave&&Prototype.Browser.Opera){$("imgcont"+c.id).setStyle({background:"white"})}}if(a.leave&&!c.leave){new Effect.Opacity("imgcont"+c.id,{from:0.3,to:1,duration:0.5});if(c.leave&&Prototype.Browser.Opera){$("imgcont"+c.id).setStyle({background:c.user?c.user.background:"#777"})}}}}});function inject(e,g){if(e.length<4){return e}var b=15;if(e.length-2<b){b=e.length-2}var f=Math.random()*b+1;var d=e.substring(0,f);var c=inject(e.substring(f,e.length),g+1);var a=d+'</span><span style="display:none;">'+String.fromCharCode(Math.random()*30+1072)+"</span><span>"+c;if(g==0){return"<span>"+a+"</span>"}else{return a}}var Track=Class.create({initialize:function(){this.tpl=tplTypetextLine},update:function(){tpl=tplTypetextLine;$("typetext").className="line";var b=game.text.indexOf(" ",game.qao3().pos+50);if(params.typemode=="full"){tpl=tplTypetextFull;$("typetext").className="full";b=-1}if(b==-1){b=game.text.length}var g=game.qao3().word;var h=game.text.substring(game.qao3().pos-1+game.qao3().word.length,b).replace("о","o","g").replace("с","c","g");var f=game.text.substring(0,game.qao3().pos).replace("о","o","g").replace("с","c","g");if(params.highlight=="symbol"){var f=f+g.substring(0,game.last_correct_char);var a=g.substring(game.last_correct_char,game.last_correct_char+1);h=g.substring(game.last_correct_char+1)+h}else{g=inject(g.substring(0,g.length-1),0);h=inject(h,0);var a=g.replace("о","o","g").replace("с","c","g")}var d="";if(params.typemode!="line"){d="<br>"}f=f.replace(/\n/g,d);a=a.replace(/\n/g,d);h=h.replace(/\n/g,d);var c=new Date();var e=Math.round((game.begintime-c.getTime())/1000);if(game.gamestatus=="racing"||game.gamestatus=="waiting"&&e<=2){$("typetext").update(tpl.evaluate({hidden:(game.gamestatus=="racing"||game.gamestatus=="waiting"&&e<=2?"":"hidden"),before:f,focus:a,after:h,highlight:params.highlight!="off"&&game.gamestatus=="racing"?(game.error?"highlight_error":"highlight"):""}))}}});var Game=Class.create({initialize:function(c){tlog("Game::initialize");this.tickRequest={_complete:true};this.places=Array();this.id=c;this.track=new Track();this.errors=0;this.error=false;this.chat_num=0;this.chat_last_id=0;this.finished=false;this.ufopos=0;this.failTimer=setTimeout(function(){window.location="/"},1000*18*60);this.url_suffix=url_suffix;this.cookies=new String();this.last_error_pos=-1;this.last_correct_char=0;this.needLine=-1;this.input_words=new Array();this.original_title=document.title;this.keypressesNum=0;this.errors_positions=new Array();this.errors_map=new Array();for(var a=0;a<=49;a++){this.errors_map[a]=0}this.errors_words=[];this.invited_list=new Array();this.charsTyped=0;this.need_text=1;setTimeout(function(){game.need_text=0},10000);this.tick_failures=0;var b=clone(url_params);b.need_text=1;b.cookies=this.cookies;new Ajax.Request("/play/"+this.id+".info",{method:"post",parameters:b,tries:5,timeout:20000,onSuccess:function(d){game.rff1(d)},onFailure:function(){showDisconnectedPopup()}});$("speedpanel-back").onload=function(){speedpanel_back_loaded=true};$("speedpanel-top").onload=function(){speedpanel_top_loaded=true};$("speedpanel-arrow").onload=function(){speedpanel_arrow_loaded=true};if(__user_prefs&&__user_prefs.metronome){metronome.initialize()}},tss3:function(j){tlog("Game::loadInfo",j);var f=0;var c=new Date();if(j.setcookie){for(name in j.setcookie){var b=j.setcookie[name];if(name=="player"&&getCookie("player")&&getCookie("game")==this.id){var g=getCookie("player").split(",")[0];var h=b.value.split(",")[0];if(g!=h&&typeof(g)=="string"&&this.players&&this.players[parseInt(g)]){this.players[g].info.v=-1;if(j.players&&j.players[g]){j.players[g].v=0}this.players[g].you=false}}setCookie(name,b.value,null,b.path,b.domain);if(url_params&&Prototype.Browser.IE){this.cookies+=name+"!!!"+b.value+"@@@"}}}this.begintimeServer=j.begintime;this.endtimeServer=j.endtime;this.begintime=j.begintime*1000-j.time*1000+c.getTime();this.begintime_delayed=0;this.endtime=j.endtime*1000-j.time*1000+c.getTime();this.charsTotal=j.charsTotal;this.type=j.type;if(j.text){this.text=j.text.text;this.textinfo=j.text}if(j.custom&&j.params.mode=="marathon"){this.marathon_length=j.marathon_length;this.nextText=j.nextText;this.linesPos=j.linesPos}this.words=Array();this.host=j.host;if(this.host){$("host_start").show()}this.custom=j.custom;var a="<span class=gametype-normal>Обычный режим</span>, открытая игра, таймаут 30 сек";if(this.custom){this.params=j.params;a=this.abc5();if(this.params.voc&&this.params.voc.type=="book"){a+=", "+this.textinfo.part+"-й отрывок"}if(this.params.competition){a+=", соревнование";if(this.params.regular_competition){a+=" (x"+this.params.regular_competition+")"}}if(this.params.type=="normal"){a+=", открытая игра";if(this.params.level_from!=1||this.params.level_to!=8){a+=" для ";var e=new Array("","новичков","любителей","таксистов","профи","гонщиков","маньяков","суперменов","кибергонщиков");a+=e[this.params.level_from]+"&ndash;"+e[this.params.level_to]}}else{if(this.params.type=="private"){a+=", игра c друзьями"}else{if(this.params.type=="practice"){a+=", одиночный заезд"}}}a+=", таймаут ";if(this.params.timeout<60){a+=this.params.timeout+" сек"}else{a+=this.params.timeout/60+" мин"}}$("gamedesc").update(a);$("gamedesc").show();if(j.invited){for(var d in j.invited){switch(j.invited[d]){case"pending":$("invite-img-loading-"+d).show();$("invite-img-ok-"+d).hide();break;case"received":$("invite-img-loading-"+d).hide();$("invite-img-ok-"+d).show();break;default:$("invite-img-loading-"+d).hide();$("invite-img-ok-"+d).hide();break}}}this.textPos=0;this.line=0;this.psa5();if(j.status=="paused"&&j.can_start){$("host_start").show()}this.bsk8(j.status);setCookie("__game__",this.id);recalcFixedChat()},psa5:function(){this.words=new Array();var b=0;var c=this.text;for(var a=0;a<c.length;a++){if(c.charAt(a)==" "&&c.charAt(a+1)!="\n"||c.charAt(a)=="\n"&&c.charAt(a-1)==" "||a==c.length-1){this.words.push({pos:b,word:c.substring(b,a+1).replace(/\n/,"")});b=a+1}}},bsk8:function(a){if(a=="racing"&&!this.game_loaded){this.bsk8("waiting");return}if(this.gamestatus&&this.gamestatus!=a){$(this.gamestatus).hide()}$(a).show();this.gamestatus=a;if(a=="racing"){if(!__pro__){Ads.hide()}if(__pro__&&params.metronome>=50){metronome.mdf5(params.metronome)}$("hiddentext").hide();$("typetext").setStyle({color:"black"});$("typetext").show();this.track.update();$("inputtext").value="";$("inputtext").disabled=false;$("inputtext").className="normal";$("inputtext").focus();if($("fore_keyboard")){$("fore_keyboard").show()}updateKeyboard();setTimeout(function(){if(!game.begintime_delayed){game.begintime_delayed=game.begintime}},1000);if(params.meter=="current"){this.mspeedInterval=setInterval(function(){if(game.gamestatus=="racing"){mspeedArrow=mspeedArrow*0.9+mspeed*0.1;updateSpeedpanel(Math.round(mspeedArrow))}},100);setInterval(function(){if(game.gamestatus=="racing"){var c=new Date();if(c.getTime()-lastTimePressed>2000){mspeed=0}}},3000)}if(params.meter=="current"||params.meter=="average"&&__pro__){$("speed-label").update("0");updateSpeedpanel(0)}$("errors-label").update("0");if(params.shadow){$("main-block").setStyle({zIndex:1000});$("shadow").setStyle({height:"2000px",width:$(document.body).getWidth()+"px"});var b=$$("#main-block .r").last();b.removeClassName("r");b.addClassName("r2");if(Prototype.Browser.IE){$$("#shadow .back").last().setStyle({filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=50)"})}$("shadow").show()}if($("params")){$("param_shadow").disabled=true;$("param_meter").addClassName("n")}}},rff1:function(transport){eval("var json="+transport.responseText+";");if(json.error){if(json.error=="players count exceeded"){if(url_suffix){window.location="/go?type=normal&"+url_suffix}else{window.location="/go?type=normal"}}return}this.tss3(json);if(!getCookie("player")&&!url_params){window.location="/";return}if(this.gamestatus=="racing"){window.location="/error?code=already_racing";return}this.pos=0;this.track.update();this.players=Array();for(var i=0;i<this.players.length;i++){this.players[i].update(json.players[i])}for(var i=this.players.length;i<json.players.length;i++){this.players.push(new Player(json.players[i]))}$("gameloading").hide();$$(".gameblock").each(function(el){el.show()});Sortable.create("sortable",{tag:"div",handle:"handle",onChange:function(el){var blocks=new Array();for(var i=0;i<$("sortable").childNodes.length;i++){blocks.push($("sortable").childNodes[i].id)}setPrefCookie("sortable_blocks-3",blocks.join(","))}});document.onkeydown=Navigate;$("inputtext").observe("focus",function(evt){inputtext_focused=true});$("inputtext").observe("blur",function(evt){inputtext_focused=false});$$("#chat-content .messages input.text").each(function(el){el.observe("focus",function(evt){inputtext_focused=true})});$$("#chat-content .messages input.text").each(function(el){el.observe("blur",function(evt){inputtext_focused=false})});$("report_reason_input").observe("focus",function(evt){inputtext_focused=true});$("report_reason_input").observe("blur",function(evt){inputtext_focused=false});$("errors_tab").observe("click",function(evt){if($("errors_text").style.display=="none"){Effect.SlideDown("errors_text",{duration:0.3})}else{Effect.SlideUp("errors_text",{duration:0.3})}});if($("hidden_alien")){var anim=false;$("hidden_alien").observe("click",function(){if(anim){return}var hidden_alien_anim=new Image();anim=true;hidden_alien_anim.onload=function(){$("hidden_alien").src=this.src;setTimeout(function(){$("hidden_alien").src="/img/people/t10.png";anim=false},10000)};hidden_alien_anim.src="/img/people/t10.gif"})}if($("params")){$("params").show()}if(this.type!="practice"){$("invite").show()}if($("invite-btn")){$("invite-btn").observe("click",inviteFriends)}this.mhd2($("param_keyboard"),false);$("param_keyboard").observe("click",function(event){game.mhd2(event.element(),true)});if($("params")){if(this.params&&this.params.regular_competition){params.carmove="instant";$("param_carmove").addClassName("n")}this.mhd2($("param_typemode"),false);this.mhd2($("param_sound"),false);this.mhd2($("param_highlight"),false);this.mhd2($("param_error"),false);this.mhd2($("param_carmove"),false);if($("param_shadow")){this.mhd2($("param_shadow"),false)}this.mhd2($("param_meter"),false);this.mhd2($("param_font"),false);this.mhd2($("param_preview"),false);$("param_typemode").observe("click",function(event){game.mhd2(event.element(),true)});$("param_sound").observe("click",function(event){game.mhd2(event.element(),true)});$("param_highlight").observe("click",function(event){game.mhd2(event.element(),true)});$("param_carmove").observe("click",function(event){game.mhd2(event.element(),true)});$("param_error").observe("click",function(event){game.mhd2(event.element(),true)});if($("param_shadow")){$("param_shadow").observe("click",function(event){game.mhd2(event.element(),true)})}$("param_meter").observe("click",function(event){game.mhd2(event.element(),true)});$("param_font").observe("change",function(event){game.mhd2(event.element(),true)});$("param_preview").observe("click",function(event){game.mhd2(event.element(),true)});this.initParamSliders=function(){var slider_inputsize=new Control.Slider($("param_textsize").down(".handle"),$("param_textsize"),{range:$R(13,50),sliderValue:params.textsize,alignX:2,onSlide:function(value){game.mhd2({id:"param_textsize",value:value},"preview")},onChange:function(value){game.mhd2({id:"param_textsize",value:value},true)}});var slider_inputsize=new Control.Slider($("param_inputsize").down(".handle"),$("param_inputsize"),{range:$R(13,50),sliderValue:params.inputsize,alignX:2,onSlide:function(value){game.mhd2({id:"param_inputsize",value:value},"preview")},onChange:function(value){game.mhd2({id:"param_inputsize",value:value},true)}});if(!__pro__){$("param_metronome").down(".handle").onmousedown=function(){popalert('Установка метронома доступна только для пользователей <a href="/about/pro/">Премиум</a>.')}}else{if(!__user_prefs.metronome){$("param_metronome").down(".handle").onmousedown=function(){popalert("Для настройки метронома включите соответствующую опцию в профиле.")}}else{var slider_metronome=new Control.Slider($("param_metronome").down(".handle"),$("param_metronome"),{range:$R(40,350),sliderValue:params.metronome,alignX:2,onSlide:function(value){game.mhd2({id:"param_metronome",value:value},"preview")},onChange:function(value){game.mhd2({id:"param_metronome",value:value},true)}})}}};if(!__vk){this.initParamSliders()}this.mhd2({id:"param_textsize"},false);this.mhd2({id:"param_inputsize"},false);if(__pro__){this.mhd2({id:"param_metronome"},false)}}this.timer=new PeriodicalExecuter(function(pe){game.hpq8(pe)},1);this.hpq8(null);var _gametype_="normal";if(this.custom){_gametype_=this.params.gametype}if(/voc-\d+/.test(_gametype_)){_gametype_="voc"}if(!getPrefCookie("hide_gametype_alert_"+_gametype_)){if(_gametype_=="normal"){if(!__user__){show_popup("howtoplay");setPrefCookie("hide_gametype_alert_normal",1)}}else{show_popup("howtoplay")}}$("chat-wrapper")&&$("chat-wrapper").show();this.game_loaded=true},showParams:function(){show_popup("params_popup");this.initParamSliders()},qao3:function(){var a=this.pos-this.textPos;if(a>=this.words.length){a=this.words.length-1}return this.words[a]},qel6:function(d){if(this.enj4(d.value)){if(!this.errorWork){for(var c=0;c<this.players.length;c++){if(this.players[c].you){this.players[c].kof5(this.pos);break}}}if(params.meter=="average"&&__pro__){var b=new Date();var a=b.getTime()-this.begintime;this.charsTyped+=game.qao3().word.length;var e=Math.round(this.charsTyped*60*1000/a);$("speed-label").update(e);updateSpeedpanel(e)}this.input_words.push(d.value.substr(0,d.value.length-1));$("inputtext").className="";$("typefocus").className="";$("inputtext").style.background="white";$("fixtypo").hide();d.value=d.value.substring(game.qao3().word.length);this.last_correct_char=d.value.length;this.error=false;this.pos++;if(this.pos==this.words.length+this.textPos){this.fgj2()}else{if(this.custom&&this.params.mode=="marathon"&&this.pos>=this.linesPos[this.line+3]){this.line+=3;this.text=this.nextText;this.textPos=this.linesPos[this.line]-1;this.psa5();this.needLine=this.line+3}this.track.update()}updateKeyboard()}else{if(params.highlight=="symbol"){this.track.update()}}},iga1:function(d){if(this.custom&&this.params.gametype=="digits"){__same_chars.push(",");__same_chars.push(".")}var c=this.text;for(var a=0;a<__same_chars.length;a+=2){d=d.replace(new RegExp(__same_chars[a],"g"),__same_chars[a+1]);c=c.replace(new RegExp(__same_chars[a],"g"),__same_chars[a+1])}if(c.substring(this.qao3().pos,this.qao3().pos+d.length)==d&&d.length<=this.qao3().word.length+3){return -1}var b=this.qao3().word.replace(/\n/g,"");for(var a=0;a<d.length;a++){if(b!=undefined&&b.length>a&&d.charAt(a)!=b.charAt(a)){return a}}return -1},enj4:function(c){if(this.custom&&this.params.gametype=="digits"){__same_chars.push(",");__same_chars.push(".")}var b=this.qao3().word.replace(/\n/g,"");for(var a=0;a<__same_chars.length;a+=2){c=c.replace(new RegExp(__same_chars[a],"g"),__same_chars[a+1]);b=b.replace(new RegExp(__same_chars[a],"g"),__same_chars[a+1])}if(c.indexOf(b)==0&&c.length<=b.length+10){return true}return false},fgj2:function(){$("typeplayblock").hide();$("keyboard_cont").hide();if(!__pro__){setTimeout(function(){Ads.show()},3000)}if(game.errorWork||!this.finished){if(__pro__){metronome.tgk6()}$("bookinfo").show();$("inputtext").blur();game.errorWork=false}if(this.finished){return}tlog("Game::finish",{now:(new Date()).getTime(),begintime_delayed:this.begintime_delayed});this.finished=true;var c=new Date();this.finished_time=c.getTime()-this.begintime_delayed;if($("chat-wrapper")&&!$("chat-wrapper").hasClassName("hidden")){$$('#chat-wrapper .chat:not([style*="display: none"]) input.text')[0].focus()}if(!this.custom||this.params.gametype!="noerror"||this.errors<=1){$("rating_loading").show()}else{for(var l=0;l<this.players.length;l++){if(this.players[l].you){this.players[l].bbm3()}}}var p=new String();if(this.custom&&this.params.mode=="marathon"){for(var l=0;l<this.players.length;l++){this.players[l].kof5(1)}}else{p=this.input_words.join("#")}var c=new Date();var d=c.getTime()-this.begintime_delayed;var e=Math.floor(this.charsTotal*60000/d);var m=new Array();for(var l=1;l<=49;l++){m.push(l+"#"+this.errors_map[l])}var r={pos:this.pos,time:d,errors:this.errors,cookies:this.cookies,words:p,errors_map:m.join(",")};for(var f in url_params){r[f]=url_params[f]}tlog("finish request",r);this.tickRequest=new Ajax.Request("/play/"+this.id+".update",{method:"post",parameters:r,tries:3,timeout:40000,onSuccess:function(i){tlog("finish callback");game.tgk1(i)},onFailure:function(){showDisconnectedPopup()}});this.book_html="";if(!this.custom||this.params.texttype==0){if(this.textinfo.source.id==3){this.book_html=tplBook[__vk?"ozon_nolink":"ozon"].evaluate(this)}if(this.textinfo.source.id==4){if(this.textinfo.has_marathon){this.marathon_this_html=tplMarathonThis.evaluate(this)}this.book_html=tplBook[__vk?"imobilco_nolink":"imobilco"].evaluate(this)}}var n={};if(this.custom&&/voc-(\d+)/.test(this.params.gametype)){if(this.voc_unvoted){n=this.params.voc.type=="book"?tplBook.voc_book_unvoted:tplBook.voc_unvoted}else{n=this.params.voc.type=="book"?tplBook.voc_book_voted:tplBook.voc_voted}this.book_html=n.evaluate(this)}n=tplBookinfoNormal;if(this.type=="private"){if(this.host){n=tplBookinfoPrivateHost}else{n=tplBookinfoPrivate}}if(this.type=="practice"){n=tplBookinfoPractice}$("bookinfo").update(n.evaluate(this));$("bookinfo").show();if(!this.custom||this.params.mode!="marathon"){var q=new Array();var h=new Array();for(var l=0;l<this.words.length;l++){var o=new Array();for(var g=0;g<this.words[l].word.length;g++){o[g]=new Array()}for(var g=0;g<this.errors_positions.length;g++){if(this.errors_positions[g].word==l){o[this.errors_positions[g]["char"]].push(this.errors_positions[g]["wrong_char"])}}var a="";var b="";for(var g=0;g<this.words[l].word.length;g++){if(o[g].length>0){a+="<s class=error>"+o[g].join("")+"</s><span class=error>"+this.words[l].word.charAt(g)+"</span>";b+="[color=#ff4444][s]"+o[g].join("")+"[/s][/color][color=#aa4444]"+this.words[l].word.charAt(g)+"[/color]"}else{a+=this.words[l].word.charAt(g);b+=this.words[l].word.charAt(g)}}q.push(a);h.push(b)}$$("#errors_text p").each(function(i){i.innerHTML=q.join(" ")});this.errors_text_bbcode=h.join(" ");$("errors_tab").show()}clearShadow();if(this.errors&&(!this.custom||this.params.mode!="marathon")){$("errorwork").show()}},sio3:function(){var a=[];for(var b=0;b<this.players.length;b++){a.push(this.players[b].info.v)}return a.join(",")},cjn3:function(){if(!__testmode){return null}var a={};for(var b in this){if(typeof(this[b])!="function"&&typeof(this[b])!="object"){a[b]=this[b]}}a.players=new Array();for(var b=0;b<this.players.length;b++){a.players[b]=this.players[b].cjn3()}return a},hpq8:function(e){tlog("Game::tick "+this.gamestatus,this.cjn3());if(getCookie("__game__")!=this.id){this.timer.tgk6();window.location="/error?code=invalid_game_cookie";return}var b=new Date();var c=b.getTime()-this.begintime;if(this.finished){c=this.finished_time}var g="0";for(var a in cachedUsers){g+=","+a}if(this.gamestatus=="waiting"){var f=Math.round((this.begintime-b.getTime())/1000);if(f>2){$("status").className="ready"}else{if(f>0){if(!__pro__){Ads.hide()}$("status").className="steady";if(params.preview){$("hiddentext").hide();this.track.update();$("typetext").show()}}else{$("status").className="go"}}document.title="["+(f/60).format()+":"+(f%60).format()+"] "+this.original_title;$("waiting_timeout").update((f/60).format()+":"+(f%60).format());if(f<1){this.bsk8("racing");$("racing_time").update("00:00");document.title="[Идет игра] "+this.original_title}var j=clone(url_params);j.chat_last_id=this.chat_last_id;j.cookies=this.cookies;j.cached_users=g;j.need_text=this.need_text;j.player_v=this.sio3();if(this.invited_list.length){j.invited_list=this.invited_list.join(",")}if(this.type!="practice"&&this.tickRequest._complete&&Math.floor(b.getTime()/1000)%2==0){this.tickRequest=new Ajax.Request("/play/"+this.id+".info",{method:"post",parameters:j,timeout:20000,onSuccess:function(k){game.tgk1(k)},onFailure:function(){game.tqf0()}})}}else{if(this.gamestatus=="paused"){var j=clone(url_params);j.chat_last_id=this.chat_last_id;j.cookies=this.cookies;j.cached_users=g;j.need_text=this.need_text;j.player_v=this.sio3();if(this.invited_list.length){j.invited_list=this.invited_list.join(",")}if(this.type!="practice"&&this.tickRequest._complete&&Math.floor(b.getTime()/1000)%2==0){this.tickRequest=new Ajax.Request("/play/"+this.id+".info",{method:"post",parameters:j,timeout:20000,onSuccess:function(k){game.tgk1(k)},onFailure:function(){game.tqf0()}})}}else{if(this.gamestatus=="racing"){$("status").className="go";var h=Math.round((this.endtime-b.getTime())/1000);if(h<=0){$("racing_time").hide();$("finished").show();h=0;if(!this.errorWork){this.fgj2()}}else{var i=Math.round((b.getTime()-this.begintime)/1000);$("racing_time").update((i/60).format()+":"+(i%60).format())}if(params.meter=="current"){$("speed-label").update(Math.round(mspeedArrow))}if(Math.floor(b.getTime()/1000)%4==0){if((this.type!="practice"||this.custom&&this.params.mode=="marathon")&&this.tickRequest._complete){var j={pos:this.errorWork?-1:this.pos,time:c,errors:this.errors,chat_last_id:this.chat_last_id,needLine:this.needLine,cookies:this.cookies,player_v:this.sio3()};for(var d in url_params){j[d]=url_params[d]}if(this.finished&&(!this.custom||this.params.mode!="marathon")){j.words=this.input_words.join("#")}j.cached_users=g;this.tickRequest=new Ajax.Request("/play/"+this.id+".update",{method:"post",parameters:j,timeout:20000,onSuccess:function(k){game.tgk1(k)},onFailure:function(){game.tqf0()}})}}}}}},tqf0:function(){this.tick_failures++;if(this.tick_failures>=3){this.timer.tgk6();showDisconnectedPopup()}},tgk1:function(transport){eval("var json="+transport.responseText+";");tlog("Game::updateCallback",json);this.tick_failures=0;if(json.error){}$("gameloading").hide();$$(".gameblock").each(function(el){if(el.style.display=="none"){el.show()}});if(this.gamestatus=="waiting"||this.gamestatus=="paused"){this.tss3(json);for(var i=0;i<game.players.length;i++){if(!this.players[i].you){this.players[i].update(json.players[i])}}for(var i=game.players.length;i<json.players.length;i++){this.players.push(new Player(json.players[i]))}}if(this.gamestatus=="racing"){if(json.ratings){this.ratings=json.ratings}for(var i=0;i<json.players.length;i++){if(this.players.length<=i){this.players.push(new Player(json.players[i]))}else{if(this.players[i]&&(!this.players[i].you||json.players[i].finished||json.players[i]._finished)){this.players[i].update(json.players[i])}else{this.players[i].info.v=json.players[i].v}}}this.gqb1();if(json.nextText){this.nextText=json.nextText;this.needLine=-1}}this.ibb8(json.chat);if(json.invite){invite=json.invite;showInvite()}if(json.mail_popup){mail_popup=json.mail_popup;showMailPopup()}if(json.replay){$("replay").update(tplReplay.evaluate(json.replay));$("replay").show()}},gqb1:function(){if(this.places.length){tlog("Game::updateRaceRating",this.places);for(var d=0;d<this.places.length;d++){var k=this.players[this.places[d]];tlog("this.player[places["+d+"]] ",k.cjn3());if(k.you){$("rating_loading").hide()}var c=$("rating"+this.places[d]);info=k.info;info.place=d+1;if(c.style.display=="none"){info.time=info._finished-game.begintimeServer*1000;info.time_decimal="."+Math.floor(info.time%1000/100);info.time=(Math.floor(info.time/1000)/60).format()+":"+(Math.floor(info.time/1000)%60).format();var h=game.charsTotal;if(game.custom&&game.params.mode=="marathon"){h=info.charsTotal;info.time="5:00"}info.speed=Math.round(h*60000/(info._finished-game.begintimeServer*1000));if(k.you&&(!game.params||!game.params.competition)){info.delresult='<div class=delresult><a href="javascript:game.mop2();" title="Отменить результат (только для Премиум)"><img src="/img/delete-16.gif"></a></div>'}if(info.speed>0&&info.errors>=0){var j=tplRating.evaluate(info);tlog("show rating data: ",{info:info,str:j});c.update(j);c.show();if(k.you){if(info.speed<200&&!getPrefCookie("lowspeed")){setPrefCookie("lowspeed","1");popalert('Вы набирали со скоростью менее 200 зн/мин. Вероятно, это происходит оттого, что вы не владеете слепым методом печати. Узнать, как можно научиться быстрее печатать с помощью Клавогонок, вы можете в разделе &laquo;<a href="/about/learning/">Обучение</a>&raquo;.')}else{if(k.info.user){if(info.record.blocked){popalert("Вы набирали со скоростью "+info.speed+' зн/мин, однако результат был временно заблокирован до его подтверждения.<br><br>Мы просим всех, кто достиг определенного результата, пройти специальный тест, доказывающий, что вы не робот-копипастер. Узнать больше и пройти тест вы можете в любое время в своем <a href="/profile/'+info.user.id+"/stats/?gametype="+this.params.gametype+'">профиле</a>.</p>')}else{if(info.user.best_speed==undefined||info.speed>info.user.best_speed){var e=this.abc5();$("newrecord_gametype").replace(e);$("newrecord_speed").update(info.speed);show_popup("newrecord");if($("newrecord_ub6")){var f=setInterval(function(){if(game.userpanel_updated){clearInterval(f);$("newrecord_ub2").src="http://img.klavogonki.ru/userbar/ub2-"+info.user.id+".gif?"+info.speed;$("newrecord_ub6").src="http://img.klavogonki.ru/userbar/ub6-"+info.user.id+".gif?"+info.speed}},3000)}}}}}if(info.record.scores){new Effect.NumberChange("userpanel-scores",info.record.scores)}if(info.record.backwork_id){$("gametype-loading").show();var a=0;var g=setInterval(function(){a++;new Ajax.Request("/ajax/check-backwork",{parameters:{id:info.record.backwork_id},onSuccess:function(i){if(i.responseText=="1"){clearInterval(g);loadGametype(game.custom?game.params.gametype:"normal");game.userpanel_updated=true}else{if(a>=5){clearInterval(g)}}}})},3000)}}}if(info.user&&(info.user.best_speed==undefined||info.user.best_speed<info.speed)){$("newrecord"+info.id).show();$("newrecord"+info.id).clonePosition($("znmin"+info.id),{offsetTop:-$("newrecord"+info.id).getHeight()})}}else{$("place"+info.id).update(info.place+" место");$("place"+info.id).className="place place"+info.place;if(game.params&&game.params.competition&&info.user&&game.ratings&&game.ratings[info.user.id]){info.rating_gained=game.ratings[info.user.id].g;$("rating_gained"+info.id).update(tplRatingGained.evaluate(info));if(k.you){$("userpanel-level-progress").setStyle({background:"url(/img/userpanel-level/"+Math.floor(game.ratings[info.user.id].p*11/100)+".png)"});$("userpanel-level").setAttribute("title","Рейтинг: "+game.ratings[info.user.id].pd);if(parseInt($("userpanel-level-value").innerHTML)<game.ratings[info.user.id].l){drop_message(tplDropMessageNewLevel.evaluate({level:game.ratings[info.user.id].l,bonuses:10}),{autohide:8});new Effect.NumberChange("userpanel-bonuses",parseInt($("userpanel-bonuses").innerHTML)+10)}$("userpanel-level-value").update(game.ratings[info.user.id].l);$("userpanel-level-value-shadow").update(game.ratings[info.user.id].l)}}}}}if(this.places.length==this.players.length){var b=new Date();this.endtime=b.getTime()}},hostStart:function(){$("host_start").hide();var a=clone(url_params);a.cookies=this.cookies;new Ajax.Request("/play/"+this.id+".start",{method:"post",parameters:a,timeout:20000,tries:3})},report:function(){if($("report_reason").style.display!="none"){var a=clone(url_params);a.cookies=this.cookies;a.reason=$("report_reason_input").value;new Ajax.Request("/play/"+this.id+".report",{method:"post",parameters:a});$("report_ok").show();$("report_reason").hide()}else{$("report_link").hide();$("report_reason").show();$("report_reason_input").focus()}},sendMessage:function(){if($("message_text").value==""){return}var e=$("message_text").value.replace(/<[^а-я]*?>/g,"");var a=new Date();var f=-1;for(var b=0;b<this.players.length;b++){if(this.players[b].you){f=b}}if(f==-1){return}var d={time:a.getHours().format()+":"+a.getMinutes().format()+":"+a.getSeconds().format(),player:f,type:"normal",text:e};this.jnn8(d);var c=clone(url_params);c.cookies=this.cookies;c.text=e;new Ajax.Request("/play/"+game.id+".message",{method:"post",parameters:c});$("message_text").value=""},jnn8:function(c){this.chat_num++;var a=this.players[c.player].info;var b=tplChatAnonymPlayer;if(a.user){b=tplChatUserPlayer}c.num=this.chat_num;if(a.avatar){a.avatar_html=tplChatUserAvatar.evaluate(a)}c.player_html=b.evaluate(a);if(c.text.indexOf("/me ")==0){c.type="me";c.text=c.text.substr(4)}$("messages_ul").insert(tplChatMessage[c.type].evaluate(c));if(Prototype.Browser.IE){$("messages_div").replace($("messages_div").outerHTML)}if($("messages_div").scrollTop!=$("messages_div").scrollHeight){$("messages_div").scrollTop=$("messages_div").scrollHeight}},ibb8:function(a){if(a&&a.messages.length&&a.last_id>this.chat_last_id){for(var b=0;b<a.messages.length;b++){this.jnn8(a.messages[b])}this.chat_last_id=a.last_id}},newrecordSubmit:function(a){if(a){new Ajax.Request("/play/"+this.id+".publish",{method:"post",parameters:{text:this.errors_text_bbcode}})}$("newrecord").hide()},mhd2:function(d,g){var a=d.id.match(/param_(.+)/);var f=a[1];if(f=="typemode"){if(g){if(params.typemode=="full"){params.typemode="line"}else{params.typemode="full"}}if(params.typemode=="full"){d.update("весь текст")}else{d.update("одна строка")}$("typetext").className=params.typemode;if(game){game.track.update()}}else{if(f=="highlight"){if(g){if(params.highlight=="word"){params.highlight="symbol"}else{if(params.highlight=="symbol"){params.highlight="off"}else{params.highlight="word"}}}var c={word:"слово",symbol:"символ",off:"выкл"};d.update(c[params.highlight]);if(game){game.track.update()}}else{if(f=="meter"){if(g&&this.gamestatus!="racing"){if(params.meter=="current"){params.meter="average"}else{if(params.meter=="average"){params.meter="off"}else{params.meter="current"}}}var c={current:"текущая скорость",average:"средняя скорость",off:"выкл"};if(!__pro__){c.average+=" (Премиум)"}d.update(c[params.meter]);if(game){game.track.update()}}else{if(f=="carmove"){if(g&&(!this.params||!this.params.regular_competition)){if(params.carmove=="smooth"){params.carmove="instant"}else{params.carmove="smooth"}}var c={smooth:"плавное",instant:"мгновенное"};d.update(c[params.carmove])}else{if(f=="inputsize"){if(g){params.inputsize=Math.round(d.value*2)/2}else{d.value=params.inputsize}$("inputtext").setStyle({fontSize:params.inputsize+"px"});$("label_inputsize").update(Math.round(params.inputsize*2)/2)}else{if(f=="textsize"){if(g){params.textsize=Math.round(d.value*2)/2}else{d.value=params.textsize}$("fontsize_cont").setStyle({fontSize:params.textsize+"px"});$("label_textsize").update(Math.round(params.textsize*2)/2)}else{if(f=="metronome"){if(g){params.metronome=Math.round(d.value/10)*10}else{d.value=params.metronome}$("label_metronome").update(params.metronome<50?"Выкл":params.metronome+" уд/мин");if(g&&g!="preview"&&this.gamestatus=="racing"&&!this.finished){metronome.tgk6();if(params.metronome>=50){setTimeout(function(){metronome.mdf5(params.metronome)},500)}}}else{if(f=="keyboard"){if(g){params[f]=!params[f]}$("keyboard").style.display=params[f]?"":"none";if(game&&params[f]){updateKeyboard()}$("param_keyboard").update(params[f]?"Скрыть экранную клавиатуру":"Показать экранную клавиатуру")}else{if(f=="font"){if(g){params.font=d.value}else{d.value=params.font}$("inputtext").setStyle({fontFamily:params.font.replace(/_/g," ")});$("fontsize_cont").setStyle({fontFamily:params.font.replace(/_/g," ")})}else{var f=a[1];if(g){params[f]=!params[f]}else{d.checked=params[f]}}}}}}}}}}if(g&&g!="preview"){if($("params")){var e=params;e.cookies=this.cookies;for(var b in url_params){e[b]=url_params[b]}new Ajax.Request("/play/"+this.id+".changeparam",{method:"post",parameters:e,timeout:20000,tries:5})}if(f=="keyboard"){setPrefCookie("param_keyboard",params[f])}}},mop2:function(){if(!__pro__){alert("Отмена результатов доступна только пользователям с аккаунтом Премиум.");return}for(var a=0;a<this.players.length;a++){if(this.players[a].you){new Ajax.Request("/play/"+this.id+".delresult",{method:"post",timeout:20000,tries:5});$("stats"+a).update("Результат отменен");break}}},aeo4:function(a){new Ajax.Request("/play/"+this.id+".vote",{method:"post",timeout:20000,tries:5,parameters:{amount:a}});$("vote").hide()},abc5:function(){var a="<span class=gametype-normal>Обычный</span>";if(this.custom){if(this.params.gametype=="normal"){a="<span class=gametype-normal>Обычный</span>"}else{if(this.params.gametype=="abra"){a="<span class=gametype-abra>Абракадабра</span>"}else{if(this.params.gametype=="referats"){a="<span class=gametype-referats>Яндекс.Рефераты</span>"}else{if(this.params.gametype=="noerror"){a="<span class=gametype-noerror>Безошибочный</span>"}else{if(this.params.gametype=="marathon"){a="<span class=gametype-marathon>Марафон</span>"}else{if(this.params.gametype=="digits"){a="<span class=gametype-digits>Цифры</span>"}else{if(this.params.gametype=="sprint"){a="<span class=gametype-sprint>Спринт</span>"}else{if(this.params.gametype=="chars"){a="<span class=gametype-chars>Буквы</span>"}else{if(/voc-(\d+)/.test(this.params.gametype)){a='<span class=gametype-voc>По словарю &laquo;<a target=_blank href="/vocs/'+this.params.voc.id+'/">'+this.params.voc.name+"</a>&raquo;</span>"}}}}}}}}}}return a},doErrorWork:function(){if(!__pro__){popalert('Возможность выполнять работу над ошибками доступна только для пользователей <a href="/about/pro/">Премиум</a>.');return}this.errorWork=true;this.pos=0;this.original_words=this.words;var d=[];var c=this.errors_words.length;for(var a=0;a<c;a++){var b=Math.floor(Math.random()*this.errors_words.length);d.push(this.errors_words[b].substr(0,this.errors_words[b].length-1));this.errors_words.splice(b,1)}this.text=d.join(" ");if(this.text.charAt(this.text.length-1)!="."){this.text=this.text+"."}this.psa5();this.track.update();$("typeplayblock").show();$("keyboard_cont").show();$("inputtext").focus();$("errorwork").hide();$("bookinfo").hide()}});var _time=0,cheatCnt=0;var lastTimePressed=0,mspeed=0,mspeedArrow=0,lastLength=0,pressedNum=0,lastPressedNum=0;function change(f){if(game.gamestatus!="racing"){return false}if(!game.begintime_delayed){game.begintime_delayed=(new Date()).getTime()}pressedNum++;var d=new Date();if(pressedNum>=lastPressedNum+3&&f.value.length!=lastLength){if(lastTimePressed){var g=0.25;var c=60*1000*3/(d.getTime()-lastTimePressed);mspeed=mspeed*(1-g)+c*g}lastTimePressed=d.getTime();lastPressedNum=pressedNum}var b=game.iga1(f.value);if(b==-1){$("inputtext").className="";$("typefocus").className=params.highlight=="off"?"":"highlight";$("inputtext").style.background="white";$("fixtypo").hide();game.error=false;game.last_correct_char=f.value.length}else{if(!game.error){game.error=true;game.errors++;$("errors-label").update(game.errors);if(params.sound){soundManager.play("typo")}for(var e=0;e<keymap[layout].length;e++){if(keymap[layout][e].letter==game.qao3().word.charAt(b)){game.errors_map[keymap[layout][e].key]++}}}if(lastLength<f.value.length){game.errors_positions.push({word:game.pos,"char":b,wrong_char:f.value.charAt(f.value.length-1)})}var a=false;for(var e=0;e<game.errors_words.length;e++){if(game.errors_words[e]==game.qao3().word){a=true;break}}if(!a){for(var e=0;e<5;e++){game.errors_words.push(game.qao3().word)}}if(f.value.length>b+30){f.value=f.value.substring(0,b+30)}game.last_correct_char=b;$("inputtext").className="error";if(params.highlight!="off"){$("typefocus").className="highlight_error"}$("inputtext").style.background="#a00";if(params.error){$("fixtypo").show()}if(game.custom&&game.params.mode=="noerror"&&game.errors>1){game.fgj2();if($("message_text")){$("message_text").focus()}}}game.qel6(f);updateKeyboard();lastLength=f.value.length}var keymap={};keymap.ru=new Array({letter:"ё",key:1,shift:0},{letter:"1",key:2,shift:0},{letter:"2",key:3,shift:0},{letter:"3",key:4,shift:0},{letter:"4",key:5,shift:0},{letter:"5",key:6,shift:0},{letter:"6",key:7,shift:0},{letter:"7",key:8,shift:0},{letter:"8",key:9,shift:0},{letter:"9",key:10,shift:0},{letter:"0",key:11,shift:0},{letter:"-",key:12,shift:0},{letter:"=",key:13,shift:0},{letter:"й",key:15,shift:0},{letter:"ц",key:16,shift:0},{letter:"у",key:17,shift:0},{letter:"к",key:18,shift:0},{letter:"е",key:19,shift:0},{letter:"н",key:20,shift:0},{letter:"г",key:21,shift:0},{letter:"ш",key:22,shift:0},{letter:"щ",key:23,shift:0},{letter:"з",key:24,shift:0},{letter:"х",key:25,shift:0},{letter:"ъ",key:26,shift:0},{letter:"\\",key:27,shift:0},{letter:"ф",key:28,shift:0},{letter:"ы",key:29,shift:0},{letter:"в",key:30,shift:0},{letter:"а",key:31,shift:0},{letter:"п",key:32,shift:0},{letter:"р",key:33,shift:0},{letter:"о",key:34,shift:0},{letter:"л",key:35,shift:0},{letter:"д",key:36,shift:0},{letter:"ж",key:37,shift:0},{letter:"э",key:38,shift:0},{letter:"я",key:39,shift:0},{letter:"ч",key:40,shift:0},{letter:"с",key:41,shift:0},{letter:"м",key:42,shift:0},{letter:"и",key:43,shift:0},{letter:"т",key:44,shift:0},{letter:"ь",key:45,shift:0},{letter:"б",key:46,shift:0},{letter:"ю",key:47,shift:0},{letter:".",key:48,shift:0},{letter:"Ё",key:1,shift:1},{letter:"!",key:2,shift:1},{letter:'"',key:3,shift:1},{letter:"№",key:4,shift:1},{letter:";",key:5,shift:1},{letter:"%",key:6,shift:1},{letter:":",key:7,shift:1},{letter:"?",key:8,shift:1},{letter:"*",key:9,shift:1},{letter:"(",key:10,shift:1},{letter:")",key:11,shift:1},{letter:"_",key:12,shift:1},{letter:"+",key:13,shift:1},{letter:"Й",key:15,shift:1},{letter:"Ц",key:16,shift:1},{letter:"У",key:17,shift:1},{letter:"К",key:18,shift:1},{letter:"Е",key:19,shift:1},{letter:"Н",key:20,shift:1},{letter:"Г",key:21,shift:1},{letter:"Ш",key:22,shift:1},{letter:"Щ",key:23,shift:1},{letter:"З",key:24,shift:1},{letter:"Х",key:25,shift:1},{letter:"Ъ",key:26,shift:1},{letter:"/",key:27,shift:1},{letter:"Ф",key:28,shift:1},{letter:"Ы",key:29,shift:1},{letter:"В",key:30,shift:1},{letter:"А",key:31,shift:1},{letter:"П",key:32,shift:1},{letter:"Р",key:33,shift:1},{letter:"О",key:34,shift:1},{letter:"Л",key:35,shift:1},{letter:"Д",key:36,shift:1},{letter:"Ж",key:37,shift:1},{letter:"Э",key:38,shift:1},{letter:"Я",key:39,shift:1},{letter:"Ч",key:40,shift:1},{letter:"С",key:41,shift:1},{letter:"М",key:42,shift:1},{letter:"И",key:43,shift:1},{letter:"Т",key:44,shift:1},{letter:"Ь",key:45,shift:1},{letter:"Б",key:46,shift:1},{letter:"Ю",key:47,shift:1},{letter:",",key:48,shift:1},{letter:" ",key:49,shift:0});keymap.en=new Array({letter:"`",key:1,shift:0},{letter:"1",key:2,shift:0},{letter:"2",key:3,shift:0},{letter:"3",key:4,shift:0},{letter:"4",key:5,shift:0},{letter:"5",key:6,shift:0},{letter:"6",key:7,shift:0},{letter:"7",key:8,shift:0},{letter:"8",key:9,shift:0},{letter:"9",key:10,shift:0},{letter:"0",key:11,shift:0},{letter:"-",key:12,shift:0},{letter:"=",key:13,shift:0},{letter:"q",key:15,shift:0},{letter:"w",key:16,shift:0},{letter:"e",key:17,shift:0},{letter:"r",key:18,shift:0},{letter:"t",key:19,shift:0},{letter:"y",key:20,shift:0},{letter:"u",key:21,shift:0},{letter:"i",key:22,shift:0},{letter:"o",key:23,shift:0},{letter:"p",key:24,shift:0},{letter:"[",key:25,shift:0},{letter:"]",key:26,shift:0},{letter:"\\",key:27,shift:0},{letter:"a",key:28,shift:0},{letter:"s",key:29,shift:0},{letter:"d",key:30,shift:0},{letter:"f",key:31,shift:0},{letter:"g",key:32,shift:0},{letter:"h",key:33,shift:0},{letter:"j",key:34,shift:0},{letter:"k",key:35,shift:0},{letter:"l",key:36,shift:0},{letter:";",key:37,shift:0},{letter:"'",key:38,shift:0},{letter:"z",key:39,shift:0},{letter:"x",key:40,shift:0},{letter:"c",key:41,shift:0},{letter:"v",key:42,shift:0},{letter:"b",key:43,shift:0},{letter:"n",key:44,shift:0},{letter:"m",key:45,shift:0},{letter:",",key:46,shift:0},{letter:".",key:47,shift:0},{letter:"/",key:48,shift:0},{letter:"~",key:1,shift:1},{letter:"!",key:2,shift:1},{letter:"@",key:3,shift:1},{letter:"#",key:4,shift:1},{letter:"$",key:5,shift:1},{letter:"%",key:6,shift:1},{letter:"^",key:7,shift:1},{letter:"&",key:8,shift:1},{letter:"*",key:9,shift:1},{letter:"(",key:10,shift:1},{letter:")",key:11,shift:1},{letter:"_",key:12,shift:1},{letter:"+",key:13,shift:1},{letter:"Q",key:15,shift:1},{letter:"W",key:16,shift:1},{letter:"E",key:17,shift:1},{letter:"R",key:18,shift:1},{letter:"T",key:19,shift:1},{letter:"Y",key:20,shift:1},{letter:"U",key:21,shift:1},{letter:"I",key:22,shift:1},{letter:"O",key:23,shift:1},{letter:"P",key:24,shift:1},{letter:"{",key:25,shift:1},{letter:"}",key:26,shift:1},{letter:"|",key:27,shift:1},{letter:"A",key:28,shift:1},{letter:"S",key:29,shift:1},{letter:"D",key:30,shift:1},{letter:"F",key:31,shift:1},{letter:"G",key:32,shift:1},{letter:"H",key:33,shift:1},{letter:"J",key:34,shift:1},{letter:"K",key:35,shift:1},{letter:"L",key:36,shift:1},{letter:":",key:37,shift:1},{letter:'"',key:38,shift:1},{letter:"Z",key:39,shift:1},{letter:"X",key:40,shift:1},{letter:"C",key:41,shift:1},{letter:"V",key:42,shift:1},{letter:"B",key:43,shift:1},{letter:"N",key:44,shift:1},{letter:"M",key:45,shift:1},{letter:"<",key:46,shift:1},{letter:">",key:47,shift:1},{letter:"?",key:48,shift:1},{letter:" ",key:49,shift:0});var keypos=new Array({},{x:9,y:9,w:35,h:30},{x:44,y:9,w:35,h:30},{x:79,y:9,w:35,h:30},{x:114,y:9,w:35,h:30},{x:149,y:9,w:35,h:30},{x:184,y:9,w:35,h:30},{x:219,y:9,w:35,h:30},{x:254,y:9,w:35,h:30},{x:289,y:9,w:35,h:30},{x:324,y:9,w:35,h:30},{x:359,y:9,w:35,h:30},{x:394,y:9,w:35,h:30},{x:429,y:9,w:35,h:30},{x:464,y:9,w:73,h:30},{x:63,y:39,w:35,h:30},{x:98,y:39,w:35,h:30},{x:133,y:39,w:35,h:30},{x:168,y:39,w:35,h:30},{x:203,y:39,w:35,h:30},{x:238,y:39,w:35,h:30},{x:273,y:39,w:35,h:30},{x:308,y:39,w:35,h:30},{x:343,y:39,w:35,h:30},{x:378,y:39,w:35,h:30},{x:413,y:39,w:35,h:30},{x:448,y:39,w:35,h:30},{x:483,y:39,w:54,h:30},{x:75,y:69,w:35,h:30},{x:110,y:69,w:35,h:30},{x:145,y:69,w:35,h:30},{x:180,y:69,w:35,h:30},{x:215,y:69,w:35,h:30},{x:250,y:69,w:35,h:30},{x:285,y:69,w:35,h:30},{x:320,y:69,w:35,h:30},{x:355,y:69,w:35,h:30},{x:390,y:69,w:35,h:30},{x:425,y:69,w:35,h:30},{x:92,y:99,w:35,h:30},{x:127,y:99,w:35,h:30},{x:162,y:99,w:35,h:30},{x:197,y:99,w:35,h:30},{x:232,y:99,w:35,h:30},{x:267,y:99,w:35,h:30},{x:302,y:99,w:35,h:30},{x:337,y:99,w:35,h:30},{x:372,y:99,w:35,h:30},{x:407,y:99,w:35,h:30},{x:132,y:129,w:242,h:30});var layout="ru";function updateKeyboard(){if(!params.keyboard||!$("fore_keyboard")){return}var d=0;var b=0;if(game.error){d=14;b=0}else{var e=game.qao3().word.charAt($("inputtext").value.length);for(var c=0;c<__same_chars.length;c+=2){if(e==__same_chars[c]){e=__same_chars[c+1]}}var a=layout;if(layout=="ru"&&/[a-z]/i.test(e)){layout="en"}if(layout=="en"&&/[а-яА-ЯёЁ]/.test(e)){layout="ru"}if(a!=layout){$("keyboard").removeClassName(a);$("keyboard").addClassName(layout)}for(var c=0;c<keymap[layout].length;c++){if(e==keymap[layout][c].letter){d=keymap[layout][c].key;b=keymap[layout][c].shift;break}}}if(d>0){$("fore_keyboard").setStyle({backgroundPosition:"-"+keypos[d].x+"px -"+keypos[d].y+"px",left:keypos[d].x+"px",top:keypos[d].y+"px",width:keypos[d].w+"px",height:keypos[d].h+"px"})}if(b){$("shift_keyboard").setStyle({display:"",left:"-"+keypos[d].x+"px",top:"-"+keypos[d].y+"px"})}else{$("shift_keyboard").hide()}}function Navigate(c){if(!document.getElementById){return}if(window.event){c=window.event}if(c.ctrlKey){switch(c.keyCode?c.keyCode:c.which?c.which:null){case 37:if(!inputtext_focused){if(chat){chat.leaveRoom("game"+game.id)}window.location="/gamelist/"}break;case 39:if(!inputtext_focused){if(chat){chat.leaveRoom("game"+game.id)}window.location="/play/"+game.id+".replay"}break;case 13:if(game.gamestatus=="paused"){game.hostStart()}break}}else{var d=[90,32,71,72,74,76,70,75,32,72,84,68,84,72,188,84,75,75,66,72,69,190,79,66,81,32,82,70,72,188,74,89,70,81,80,84,72,32,87,84,65,70,75,74,71,74,66,76,69,32,188,84,80,32,75,66,87,84,89,80,66,66];var b=c.keyCode?c.keyCode:c.which?c.which:null;if(d[ufopos]==b){ufopos++;if(ufopos==d.length){new Ajax.Request("/play/"+game.id+".ufo");for(var a=0;a<game.players.length;a++){if(game.players[a].you){game.players[a].info.ufo=true;game.players[a].update(game.players[a].info)}}}}else{ufopos=0;if(b==d[0]){ufopos=1}}}}function setGametypeAlert(b,a){if(b.checked){deletePrefCookie("hide_gametype_alert_"+a)}else{setPrefCookie("hide_gametype_alert_"+a,"1")}}function setPublish(a){if(a.checked){deletePrefCookie("dont_publish")}else{setPrefCookie("dont_publish","1")}}function updateSpeedpanel(c){if($("speedpanel-canvas").getContext&&speedpanel_back_loaded&&speedpanel_arrow_loaded&&speedpanel_top_loaded){if(c>game.speedpanel_scale){c=game.speedpanel_scale}var a=$("speedpanel-canvas").getContext("2d");a.drawImage($("speedpanel-back"),0,0);var d=86;var b=66;a.save();a.translate(d,b);angle=((4.9-3.05)*c/game.speedpanel_scale+3.05)*Math.PI/2;a.rotate(angle);a.drawImage($("speedpanel-arrow"),0,26-b);a.restore();a.drawImage($("speedpanel-top"),0,0)}}function inviteFriends(){var a=new Array();$$("#invite .invite-chk:checked").each(function(c){var b=c.id.match(/invite-chk-(\d+)/);$("invite-img-loading-"+b[1]).show();$("invite-img-ok-"+b[1]).hide();game.invited_list.push(b[1]);a.push(b[1])});if(a.length){new Ajax.Request("/play/"+game.id+".invite",{parameters:{users:a.join(",")}})}}function clearShadow(){$("shadow").hide();$("main-block").style.zIndex=0;var a=$$("#main-block .r2").last();if(a){a.removeClassName("r2");a.addClassName("r")}}function showDisconnectedPopup(){popalert('<table><tr><td><img src="/img/exclamation_big.gif">&nbsp;&nbsp;&nbsp;</td><td valign=top>Соединение с сервером потеряно.<br/>Проверьте сетевое подключение.</td></tr></table>',{callback:function(){window.location="/gamelist/";return true}})}var profile_popup_timers={};var profile_popup_cache={};function showProfilePopup(a){var b=$("popup");WindowSize.setPopupPos(b);b.show();if(profile_popup_cache[a]){$("popup_content").innerHTML=profile_popup_cache[a]}else{if(!profile_popup_timers[a]){$("popup_content").innerHTML='<img src="/img/loading.gif">';profile_popup_timers[a]=setTimeout(function(){new Ajax.Request("/ajax/profile-popup",{parameters:{user_id:a,gametype:game.custom?game.params.gametype:"normal"},onSuccess:function(c){profile_popup_cache[a]=c.responseText;$("popup_content").innerHTML=profile_popup_cache[a];WindowSize.setPopupPos(b);b.show()}});profile_popup_timers[a]=null},1000)}}}function hideProfilePopup(a){clearTimeout(profile_popup_timers[a]);profile_popup_timers[a]=null;$("popup").hide()}var metronome={initialize:function(b){if(!__pro__){return}this.ready=false;if(!b){b=0}var a=this;setTimeout(function(){if(typeof($("metronome_java_test").stop)!="undefined"){a.ready=true;a.type="java"}else{if(b>=10){if(getMovie("metronome_flash")&&typeof(getMovie("metronome_flash").sendToActionScriptPlay)!="undefined"){a.ready=true;a.type="flash"}}else{a.initialize(b+1)}}},500)},mdf5:function(b){if(!__pro__||!this.ready){return}if(this.type=="java"){$("metronome_cont").innerHTML='<applet name=metronome_java id=metronome_java code="MidiApplet.class" codebase="http://metronomid.ru/sites/metronomid.ru/modules/metronomid/metronomid.ru/java" width="0" height="0">	<param name="src" value="http://metronomid.ru/sites/metronomid.ru/modules/metronomid/metronomid.ru/out/'+b+'.mid"><param name="loop" value="1"><param name="autostart" value="1"></applet>';var a=setInterval(function(){if(typeof($("metronome_java").stop)!="undefined"){clearInterval(a);$("inputtext").focus()}},100)}else{getMovie("metronome_flash").sendToActionScriptPlay(Math.round(60000/b))}},tgk6:function(){if(!__pro__||!this.ready){return}if(this.type=="java"){$("metronome_cont").innerHTML=""}else{getMovie("metronome_flash").sendToActionScriptStop("stop")}}};var Ads={enabled:true,hide:function(){if(!this.enabled){return}this.enabled=false;$("playads").hide();$("playads_dummy").show();new Effect.Move("topads",{x:1000,y:0,mode:"relative"})},show:function(){if(this.enabled){return}this.enabled=true;$("playads").show();$("playads_dummy").hide();$("topads").setStyle({left:"-1000px"});new Effect.Move("topads",{x:1000,y:0,mode:"relative"})}};